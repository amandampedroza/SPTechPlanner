<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="website icon" type="png" href="./img/logols.png">
  <script src="https://kit.fontawesome.com/88fed8b646.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="./js/sessao.js"></script>
  <link rel="stylesheet" href="./css/dash.css">
  <title>Dashboard</title>
</head>

<!-- <body onload="validarSessao()"> -->



<body onload="buscarFaltas(), kpiFaltas(), buscarMedias(), buscarProvasSprint(), buscarMediasProvas()">

  <header>
    <a class="logo">
      SPTech Planner
    </a>
    <nav class="navbar">
      <a href="./tabelas.html">Coleta de dados</a>
      <a href="index.html"><i class="fa-solid fa-right-from-bracket"></i></a>
  </header>

  <div class="titulo">
    <!-- <h1>Meu desempenho
      <i style="font-size: 30px;" class="fa-solid fa-magnifying-glass-chart"></i>
    </h1> -->

    <h2> Ol√°, <span id="b_usuario"></span>! üëã</h2>
  </div>

  <select class="sem1" id="filtro" onclick="filtroDash()">
    <option value="1">M√©dias</option>
    <option value="2">Provas</option>
  </select>

  <div class="todoCurso" id="todoCurso">
    <div class="kpis">
      <div class="kpi">
        <div class="texto-kpi">
          Maior m√©dia:
        </div>
        <div style="font-size: 30px;" id="div_maiorMedia"></div>
      </div>

      <div class="kpi">
        <div class="texto-kpi">
          Menor m√©dia:
        </div>
        <div style="font-size: 30px;" id="div_menorMedia"></div>
      </div>

      <div class="kpi">
        <div class="texto-kpi">
          M√©dia geral:
        </div>
        <div style="font-size: 40px;" id="div_media"></div>
      </div>


      <div class="kpi">
        <div class="texto-kpi">
          Faltas:
        </div>
        <div style="font-size: 40px;" id="div_faltas"></div>
      </div>
    </div>

    <div class="graficos">
      <div>
        <h1 class="tituloGraficos">M√©dias gerais</h1>
        <canvas id="myChartMedias" width="750px"></canvas>
      </div>

      <div>
        <h1 class="tituloGraficos">Faltas</h1>
        <canvas id="myChartFaltas" width="400px"></canvas>
      </div>
    </div>
  </div>
  </div>

  <!-- POR PROVA -->

  <div class="semestre" id="semestre">
    <div class="kpis">
      <div class="kpi">
        <div class="texto-kpi">
          Maior m√©dia:
        </div>
        <div style="font-size: 35px;" id="div_maiorMediaSemestre"></div>
      </div>

      <div class="kpi">
        <div style="font-size: 25px;" class="texto-kpi">
          Menor m√©dia:
        </div>
        <div style="font-size: 40px;" id="div_menorMediaSemestre"></div>
      </div>

      <div class="kpi">
        <div class="texto-kpi">
          M√©dia geral:
        </div>
        <div style="font-size: 40px;" id="div_mediaSemestre"></div>
      </div>


      <div class="kpi">
        <div class="texto-kpi">
          Faltas:
        </div>
        <div style="font-size: 40px;" id="div_faltasSemestre"></div>
      </div>
    </div>

    <div class="graficos2" style="width: 750px;">
      <div>
        <h1 class="tituloGraficos">M√©dia das provas por Sprint</h1>
        <canvas id="myChartProvasSprint"></canvas>
      </div>

      <div>
        <h1 class="titulo">M√©dia das provas por mat√©ria</h1>
        <canvas id="myChartMediaProvas"></canvas>
      </div>
    </div>
  </div>
  </div>



</body>

</html>

<script>

  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

  function filtroDash() {
    if (filtro.value == 1) {
      document.getElementById("semestre").style.display = 'none';
      document.getElementById("todoCurso").style.display = 'flex';
      // document.getElementById("sprint").style.display = 'none';
    } else if (filtro.value == 2) {
      document.getElementById("semestre").style.display = 'flex';
      document.getElementById("todoCurso").style.display = 'none';
      // document.getElementById("SP3").style.display = 'none';
      // } else if (todoCurso.value == 'SP3') {
      //     document.getElementById("SP3").style.display = 'flex';
      //     document.getElementById("SP1").style.display = 'none';
      //     document.getElementById("SP2").style.display = 'none';
      // 
    }
  }




  var listaFaltas = []
  var listaMateria = []
  var listaMedias = []
  var listaMateriaMedia = []

  let myChartMedias;
  function buscarMedias() {
    var aluno = sessionStorage.ID_ALUNO;


    fetch(`/dashboard/buscarMedias/${aluno}`, {
      method: "GET"
    }).then(response => {
      if (response.ok) {
        response.json().then(json => {

          let listaMateriaMedia = [];
          let listaMedias = [];

          if (!json || json.length === 0) {
            listaMedias.push(0);
            listaMateriaMedia.push('Sem dados')
            maiorMateria = listaMateriaMedia[0]
            menorMateria = listaMateriaMedia[0]
            maior = listaMedias[0]
            menor = listaMedias[0]
          } else {

          for (let i = 0; i < json.length; i++) {
            listaMateriaMedia.push(json[i].materia);
            listaMedias.push(Number(json[i].notaFinal));
          }

       

          
          var maior = listaMedias[0];
          var menor = listaMedias[0];
          var maiorMateria = listaMateriaMedia[0];
          var menorMateria = listaMateriaMedia[0];

       

            // Determina a maior e menor nota
            for (let i = 0; i < listaMedias.length; i++) {
              var materia_atual = listaMateriaMedia[i];
              var nota_atual = listaMedias[i];

              if (nota_atual > maior) {
                maior = nota_atual;
                maiorMateria = materia_atual;
              }

              if (nota_atual < menor) {
                menor = nota_atual;
                menorMateria = materia_atual;
              }
            }
          }

          // Calcular a soma de todos os elementos
          var soma = listaMedias.reduce((acc, valor) => acc + valor, 0);

          // Calcular a m√©dia
          var media = soma / listaMedias.length;

          div_maiorMedia.innerHTML = `${maior} <br> ${maiorMateria}`;
          div_menorMedia.innerHTML = `${menor} <br> ${menorMateria}`;
          div_media.innerHTML = media.toFixed(2);

          const cores = [
            "#FF5733", "#33FF57", "#3357FF", "#FF33A1", "#FF9133", "#9B33FF",
            "#33FFD7", "#FF5733", "#57FF33", "#3357FF"
          ];

          if (myChartMedias) {
            myChartMedias.destroy(); // Destr√≥i o gr√°fico anterior se houver
          }

          // Criando o gr√°fico ap√≥s preencher os arrays corretamente
          const ctx_medias = document.getElementById(`myChartMedias`);
          myChartMedias = new Chart(ctx_medias, {
            type: "bar",
            data: {
              labels: listaMateriaMedia,
              datasets: [
                {
                  label: "Notas por mat√©ria",
                  data: listaMedias,
                  borderWidth: 2,
                  backgroundColor: cores
                }
              ],
            },
            options: {
        scales: {
            x: {
                ticks: {
                    color: "black" // Cor dos labels do eixo X
                }
            },
            y: {
                ticks: {
                    color: "black" // Cor dos labels do eixo Y
                }
            }
        }}
          });
        });
      } else {
        console.error('Erro ao obter dados por quadrante');
      }
    }).catch(error => {
      console.error('Erro na requisi√ß√£o:', error);
    });
  }


  let myChartFaltas;
  function buscarFaltas() {
    var aluno = sessionStorage.ID_ALUNO;

    fetch(`/dashboard/buscarFaltas/${aluno}`, {
      method: "GET"
    }).then(response => {
      if (response.ok) {
        response.json().then(json => {


          // Loop para preencher as listas
          for (let i = 0; i < json.length; i++) {
            listaFaltas.push(json[i].qtdFaltas);
            listaMateria.push(json[i].materia);

          }
          if (!json || json.length === 0 || json[0].qtdFaltas == null) {
            listaFaltas.push(100);
            listaMateria.push('Presen√ßa');
          }

          //     const cores = [
          //   "#FF5733", "#33FF57", "#3357FF", "#FF33A1", "#FF9133", "#9B33FF", 
          //   "#33FFD7", "#FF5733", "#57FF33", "#3357FF"
          // ];
          // Verifica se j√° existe um gr√°fico e o destr√≥i antes de criar um novo
          if (myChartFaltas) {
            myChartFaltas.destroy();
          }

          // Criando o gr√°fico ap√≥s preencher os arrays corretamente
          const ctx2_faltas = document.getElementById(`myChartFaltas`);
          myChartFaltas = new Chart(ctx2_faltas, {
            type: "doughnut",
            data: {
              labels: listaMateria,
              datasets: [
                {
                  label: "Faltas por mat√©ria",
                  data: listaFaltas,
                  borderWidth: 2
                }
              ],
            },
          });
        });
      } else {
        console.error('Erro ao obter dados por quadrante');
      }
    });
  }


  function kpiFaltas() {
    var aluno = sessionStorage.ID_ALUNO
    fetch(`/dashboard/kpiFaltas/${aluno}`, {
      method: "GET"
    }).then(response => {
      if (response.ok) {
        response.json().then(json => {
          if (!json || json.length === 0 || json[0].faltas == null) {
            div_faltas.style.fontSize = '25px'
            div_faltas.innerHTML = `0 <br> Parab√©ns! üéâ`
          }
          else {
            div_faltas.innerHTML = json[0].faltas
          }
        })
      } else {
        console.error('Erro ao obter dados por quadrante');
      }
    })
  } 

  var listaMediaProvas = []
  var listaSprint = []

  let myChartProvasSprint
  function buscarProvasSprint() {
    var aluno = sessionStorage.ID_ALUNO;

    fetch(`/dashboard/buscarProvasSprint/${aluno}`, {
      method: "GET"
    }).then(response => {
      if (response.ok) {
        response.json().then(json => {


          
          for (let i = 0; i < json.length; i++) {
            listaMediaProvas.push(json[i].mediaSprint);
            listaSprint.push(json[i].sprint);

          }
      
          // Verifica se j√° existe um gr√°fico e o destr√≥i antes de criar um novo
          if (myChartProvasSprint) {
            myChartProvasSprint.destroy();
          }

          // Criando o gr√°fico ap√≥s preencher os arrays corretamente
          const ctx_sprint = document.getElementById(`myChartProvasSprint`);
          myChartProvasSprint = new Chart(ctx_sprint, {
            type: "line",
            data: {
              labels: listaSprint,
              datasets: [
                {
                  label: "M√©dia por Sprint",
                  data: listaMediaProvas,
                  borderWidth: 2
                }
              ],
            },
            options: {
        scales: {
            x: {
                ticks: {
                    color: "black" // Cor dos labels do eixo X
                }
            },
            y: {
                ticks: {
                    color: "black" // Cor dos labels do eixo Y
                }
            }
        }}
          });
        });
      } else {
        console.error('Erro ao obter dados por quadrante');
      }
    });
  }


  let myChartMediaProvas;
  function buscarMediasProvas() {
    var aluno = sessionStorage.ID_ALUNO;

    fetch(`/dashboard/buscarMediasProvas/${aluno}`, {
      method: "GET"
    }).then(response => {
      if (response.ok) {
        response.json().then(json => {

          let listaMateriaMediaProvas = [];
          let listaMediasProvas = [];

          if (!json || json.length === 0) {
            listaMediasProvas.push(0);
            listaMateriaMediaProvas.push('Sem dados')
            maiorMateriaProva = listaMateriaMediaProvas[0]
            menorMateriaProva = listaMateriaMediaProvas[0]
            maior = listaMediasProvas[0]
            menor = listaMediasProvas[0]
          } else {

          for (let i = 0; i < json.length; i++) {
            listaMateriaMediaProvas.push(json[i].nome);
           listaMediasProvas.push(Number(json[i].mediaProvas));
          }

       

          
          var maior = listaMediasProvas[0];
          var menor = listaMediasProvas[0];
          var maiorMateriaProva = listaMateriaMediaProvas[0];
          var menorMateriaProva = listaMateriaMediaProvas[0];

      
            for (let i = 0; i <listaMediasProvas.length; i++) {
              var materia_atual = listaMateriaMediaProvas[i];
              var nota_atual =listaMediasProvas[i];

              if (nota_atual > maior) {
                maior = nota_atual;
                maiorMateriaProva = materia_atual;
              }

              if (nota_atual < menor) {
                menor = nota_atual;
                menorMateriaProva = materia_atual;
              }
            }
          }

          // Calcular a soma de todos os elementos
          var soma =listaMediasProvas.reduce((acc, valor) => acc + valor, 0);

          // Calcular a m√©dia
          var media = soma /listaMediasProvas.length;

          div_maiorMedia.innerHTML = `${maior} <br> ${maiorMateriaProva}`;
          div_menorMedia.innerHTML = `${menor} <br> ${menorMateriaProva}`;
          div_media.innerHTML = media.toFixed(2);

          const cores = [
            "#FF5733", "#33FF57", "#3357FF", "#FF33A1", "#FF9133", "#9B33FF",
            "#33FFD7", "#FF5733", "#57FF33", "#3357FF"
          ];

          if (myChartMediaProvas) {
            myChartMediaProvas.destroy(); // Destr√≥i o gr√°fico anterior se houver
          }

          const ctx_MediaProvas = document.getElementById(`myChartMediaProvas`);
          myChartMediaProvas = new Chart(ctx_MediaProvas, {
            type: "bar",
            data: {
              labels: listaMateriaMediaProvas,
              datasets: [
                {
                  label: "Notas por mat√©ria",
                  data:listaMediasProvas,
                  borderWidth: 2,
                  backgroundColor: cores
                }
              ],
            },
            options: {
        scales: {
            x: {
                ticks: {
                    color: "black" // Cor dos labels do eixo X
                }
            },
            y: {
                ticks: {
                    color: "black" // Cor dos labels do eixo Y
                }
            }
        }}
          });
        });
      } else {
        console.error('Erro ao obter dados por quadrante');
      }
    }).catch(error => {
      console.error('Erro na requisi√ß√£o:', error);
    });
  }
  



</script>